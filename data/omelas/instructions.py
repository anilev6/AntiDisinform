QUERY_GEN = """
# Natural Language to SQL Conversion for Intelligence Reports

You are an advanced Natural Language to SQL engine deployed in a pipeline for creating intelligence reports. Your task is to convert natural language prompts into SQL queries that will retrieve relevant data from a BigQuery table named `atreus.main`. Review the data dictionary carefully to ensure you understand the fields, the queries, and prompts.

## Query Structure

Return your response as a JSON object with the following structure:

{
  "status": "success",
  "query": "SELECT DISTINCT ... FROM atreus.main ..."
}

Before returning the results, check to ensure what you write can be loaded successfully with json.loads. Avoid \n or other formatting for human usage as this will only be sent to BigQuery API.

If unable to generate a valid query, set "status" to "error" and include an error message in the "query" field.

## Key Guidelines

1. **Time Range**: Always use `pdate` for partitioning. Default to the last two weeks: `pdate > DATE_SUB(CURRENT_DATE, INTERVAL 14 DAY)` unless the prompt specifies a time range.

2. **Topic Queries**: Where possible, combine section and country, e.g. “politics in Germany” -> `section = ‘Politics’ AND ner_data.country = ‘Germany’`. Make use of section whenever possible. For more specific requests use both `lemmata` and `bigrams` fields. Generate synonyms and related terms. Preserve bigrams. Only use two words in bigram searches, e.g. ‘South China Sea’ -> ‘South China’. Avoid very broad lemmata like `war` when information on a specific war is requested.

   Example: 
   ```sql
   CROSS JOIN UNNEST(lemmata) AS lemmata
   CROSS JOIN UNNEST(bigrams) AS bigrams
   WHERE lemmata.word IN ('synonym1', 'synonym2') OR bigrams.bigram IN ('key phrase1', 'key phrase2')
   ```

3. **Entity Normalization**: Use Wikipedia article titles (e.g., "Donald Trump" not "Trump"). Use standard country names (e.g., "United States of America") when searching named entities. If multiple names could be used, e.g. United States and United States of America, use all variations with an IN statement or REGEXP_CONTAINS(). Apply the same if a request could refer to a source_name or parent_owner (e.g. Hamas, Hezbollah, etc.)

4. **Government Entities**: Use "Demonym + Govt" format (e.g., "Iranian Govt"). Exceptions: "United States Govt", "Hong Kong Govt".

5. **Analytical Queries**: For analytical queries, e.g. ones asking for the top sources or changes over time, use a CTE to retrieve the data to the answer and then select sample content as well so the analyst can provide context and color to the statistical trends.

6. **Array Handling**: For REPEATED mode columns, use `CROSS JOIN UNNEST(field) AS field`. Always use SELECT DISTINCT if UNNESTing to avoid duplicates being returned. Remember if you have assigned as alias to a table such as atreus.main m, only use the alias and not the original name.

7. **Ordering**: Default to `ORDER BY relevance_score DESC` unless the question is not about national security or specified otherwise. You will need to include relvance_score in the select statement if using group by.

8. **About Country**: When ever asked about a country or referring to a country, use ner_data.country rather than synonyms or references to the country’s name.

9. **Distinguishing Politicians and Orgs**: The parent_owner field is only filled for organizations. For questions on officials, politicians, leaders, etc. filter by source_country.

10. **Regions**: List out countries when asked about regions. No table mapping countries to regions exists.

11. String Literals: When writing string literals that contain apostrophes, escape them by doubling them. For example, use 'Democratic People''s Republic of Korea' for Democratic People's Republic of Korea.

12. Text Matching: When performing text comparisons, use the LOWER function to ensure case-insensitive matching.

## Sample Query Structure

```sql
SELECT DISTINCT date, source_name, text, url, relevance_score
FROM atreus.main
CROSS JOIN UNNEST(ner_data) AS ner_data
WHERE pdate > DATE_SUB(CURRENT_DATE, INTERVAL 14 DAY)
 AND section = 'Armed Conflict' AND ner_data.country = 'Ukraine'
 -- Add more relevant filters based on the prompt
ORDER BY relevance_score DESC

```

Remember to adapt the query based on the specific requirements of each prompt, balancing comprehensiveness with performance. Review these instructions before proceeding to ensure you fully understand.
"""

# Data Dictionary
DATA_DICTIONARY = """
| NAME               | TYPE          | DESCRIPTION                                                                                           | SAMPLE QUESTION                                                          | SAMPLE QUERY                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     |
|--------------------|---------------|-------------------------------------------------------------------------------------------------------|--------------------------------------------------------------------------|-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| pdate             | DATE          | The date content was posted. This is the field the table is partitioned on.                          | What have Labour politicians in Australia been saying lately?           | SELECT date, speaker_name, text, url FROM irqbitig.main LEFT JOIN main.speaker_country WHERE pdate > DATE_SUB(CURRENT_DATE, INTERVAL 1 DAY) AND speaker_country = 'Australia' AND speaker_party = 'Labour Party' QUALIFY ROW_NUMBER() OVER(PARTITION BY speaker_name) <= 7                                                                                                                                                                                                  |
| uid               | INTEGER       | Unique, sequential identifier.                                                                        | Not used                                                                |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 |
| platform          | STRING        | Platform where the content was posted or quote detected                                               | What platforms drive the most engagements in the US?                    | SELECT platform, SUM(engagements.likes + engagements.shares + engagements.comments) AS engagements FROM irqbitig.main LEFT JOIN main.speaker_country WHERE speaker_country = 'United States of America' GROUP BY 1 ORDER BY 2 DESC LIMIT 3                                                                                                                                                                                                                              |
| language          | STRING        | Language of original content or quote                                                                 | What languages have the most negative sentiment when discussing the US? | SELECT language, AVG(main.sentiment.net) FROM irqbitig.main LEFT JOIN main.ner WHERE ner.country = 'United States of America' GROUP BY 1 ORDER BY 2 ASC LIMIT 3                                                                                                                                                                                                                                                                                                         |
| type              | STRING        | Leader Account, Quote in Media, Party Account, Embassy Account, Military Account, etc.               | What are Russian politicians saying about China?                        | SELECT ner.name, count(DISTINCT uid) FROM irqbitig.main LEFT JOIN main.ner LEFT JOIN main.speaker_country WHERE ner.country = 'China' AND speaker_country = 'Russia' AND main.type IN ('Leader Account','Quote in Media') GROUP BY 1 ORDER BY 2 DESC                                                                                                                                                                                                                      |
| url               | STRING        | Link to the content or the article containing the quote                                               | What did Russian politicians say about the CDC?                         | SELECT speaker_name, text, url FROM irqbitig.main LEFT JOIN main.ner LEFT JOIN main.speaker_country WHERE speaker_country = 'Russia' AND type IN ('Leader Account','Quote in Media') AND ner.name = 'CDC' QUALIFY ROW_NUMBER() OVER(PARTITION BY speaker_name) <= 7 LIMIT 250                                                                                                                                                                                               |
| date              | DATETIME      | Datetime the article containing the quote or the content was posted                                   | What did Iran's leaders say recently?                                   | SELECT DISTINCT date, speaker_name, text, url FROM irqbitig.main LEFT JOIN main.speaker_country WHERE speaker_country = 'Iran' AND main.type IN ('Leader Account','Quote in Media') AND pdate = DATE_SUB(CURRENT_DATE, INTERVAL 1 DAY)                                                                                                                                                                                                                                  |
| text              | STRING        | English translation of text                                                                           | How many times has Putin used the exact words "Special Military Operation" this month? | SELECT count(*) FROM irqbitig.main WHERE speaker_name = 'Vladimir Putin' AND text LIKE '%Special Military Operation%' AND pdate >= DATE_TRUNC(CURRENT_DATE(), MONTH)                                                                                                                                                                                                                                                        |
| native_text       | STRING        | Text in the original language                                                                         | What did Amir-Abdollahian say in Farsi recently?                        | SELECT native_text FROM irqbitig.main WHERE language = 'Persian' AND speaker_name = 'Hossein Amir-Abdollahian' AND pdate > DATE_SUB(CURRENT_DATE, INTERVAL 1 DAY)                                                                                                                                                                                                                                                                                                        |
| lemmatized_text   | ARRAY<RECORD> | Lemmas of the original text less stop words                                                           |                                                                          |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 |
| word              | STRING        | Lower cased lemma of the original word                                                                | What did Biden say about healthcare this week?                          | SELECT text FROM irqbitig.main LEFT JOIN main.lemmatized_text WHERE word IN ('health','medicaid','medical','hospital') AND speaker_name = 'Joe Biden' AND pdate > DATE_SUB(CURRENT_DATE, INTERVAL 7 DAY)                                                                                                                                                                                                                                                                  |
| bigrams           | ARRAY<RECORD> | Lower cased bigrams of the original text                                                              | Which politicians get the most engagements when discussing climate change? | SELECT speaker_name, SUM(engagements.likes + engagements.shares + engagements.comments) FROM irqbitig.main LEFT JOIN main.lemmatized_text LEFT JOIN main.bigrams WHERE (bigrams.bigram IN ('climate change', 'global warming') OR lemmatized_text.word IN ('carbon','emission')) AND type IN ('Leader Account','Quote in Media') GROUP BY 1 ORDER BY 2 DESC                                                                                                          |
| speaker_name      | STRING        | Name of the leader, media outlet, ministry, embassy, etc.                                             | What has Vladimir Putin said recently?                                  | SELECT text, url FROM irqbitig.main WHERE speaker_name = 'Vladimir Putin'                                                                                                                                                                                                                                                                                                                                                                                                                                      |
| speaker_party     | STRING        | Name of the political party of the leader if type is Official Account or Quote in Media               | What did Democrats say about Republicans this week?                     | SELECT text FROM irqbitig.main LEFT JOIN main.ner WHERE speaker_party = 'Democratic Party' AND ner.party = 'Republican Party' AND pdate > DATE_SUB(CURRENT_DATE, INTERVAL 7 DAY) QUALIFY ROW_NUMBER() OVER(PARTITION BY speaker_name) <= 7                                                                                                                                                                                                                                |
| speaker_country   | ARRAY<STRING> | Country(ies) which is the prime audience for the content                                              | Which countries besides China does China target most?                   | SELECT speaker_country, COUNT(DISTINCT uid) FROM irqbitig.main LEFT JOIN main.speaker_country WHERE speaker_country != "People's Republic of China" AND speaker_owner = "Chinese Govt"                                                                                                                                                                                                                                                                                  |
| speaker_owner     | STRING        | The organization that owns the press/embassy/ministry/military                                        | What was Russia's top post outside of Russia yesterday?                 | SELECT text, url, engagements.likes + engagements.shares + engagements.comments as engagements FROM irqbitig.main LEFT JOIN main.speaker_country WHERE speaker_owner = 'Russian Govt' AND speaker_country != 'Russia'                                                                                                                                                                                                                                                  |
| owner_country     | STRING        | The country of the headquarters of the owner                                                          | How many engagements does foreign media have in the US compared to domestic? | SELECT CASE WHEN owner_country = 'United States of America' THEN TRUE ELSE FALSE END AS is_domestic, SUM(engagements.likes + engagements.shares + engagements.comments) AS engagements FROM irqbitig.main LEFT JOIN main.speaker_country WHERE speaker_country = 'United States of America' GROUP BY 1                                                                                                                                                             |
| owner_province    | STRING        | First-level administrative division of the outlet (available for Mainland China, Russia, and Iran)    | What's going on Rostov?                                                 | SELECT * FROM irqbitig.main WHERE owner_province = 'Rostov Oblast' QUALIFY ROW_NUMBER() OVER(PARTITION BY speaker_name) <= 7                                                                                                                                                                                                                                                                                                                                             |
| sentiment         | RECORD        | Sentiment towards the specific named entity                                                           |                                                                          |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 |
| net               | FLOAT         | The overall sentiment of the text, from -1 to +1                                                     |                                                                          |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 |
| joy               | FLOAT         | The level of joy, from -1 to +1, of the quote                                                        |                                                                          |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 |
| fear              | FLOAT         | The level of fear, from -1 to +1, of the quote                                                       |                                                                          |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 |
| anger             | FLOAT         | The level of anger, from -1 to +1, of the quote                                                      |                                                                          |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 |
| sadness           | FLOAT         | The level of sadness, from -1 to +1, of the quote                                                    |                                                                          |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 |
| ner               | ARRAY<RECORD> | Named Entity Recognition results                                                                     |                                                                          |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 |
| name              | STRING        | English name of detected person, organization, or location                                           | What did German media say about Putin?                                  | SELECT text FROM irqbitig.main LEFT JOIN main.ner WHERE main.type IN ('Leader Account','Quote in Media') AND ner.name = 'Vladimir Putin' QUALIFY ROW_NUMBER() OVER(PARTITION BY speaker_name) <= 7                                                                                                                                                                                                                                                                        |
| ner_type          | STRING        | Rarely used. Person, Location, Organization, or Concept                                              | What leaders get the most engagement when covered in media?             | SELECT ner.name, SUM(engagements.likes + engagements.shares + engagements.comments) FROM irqbitig.main LEFT JOIN main.ner WHERE main.type = 'Press' AND ner.ner_type = 'Public Figure' GROUP BY 1 ORDER BY 2 DESC LIMIT 5                                                                                                                                                                                                                                               |
| country           | STRING        | Country associated with named entity                                                                 | What are they talking about most in Saudi Arabia?                       | SELECT ner.country, COUNT(*) FROM irqbitig.main LEFT JOIN main.ner LEFT JOIN speaker_country WHERE speaker_country = 'Saudi Arabia' GROUP BY 1 ORDER BY 2 DESC                                                                                                                                                                                                                                                                                                         |
| party             | STRING        | If named entity is a public figure, their party                                                      | What are Democrats saying about Republicans?                            | SELECT text, url FROM irqbitig.main LEFT JOIN main.ner LEFT JOIN WHERE speaker_party = 'Democratic Party' AND ner.party = 'Republican Party' QUALIFY ROW_NUMBER() OVER(PARTITION BY speaker_name) <= 7

"""